name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  validate:
    name: Validate Scripts and Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ShellCheck - Validate Bash Scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: error
          ignore_paths: '.git .github'
        env:
          SHELLCHECK_OPTS: -e SC2155

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: PSScriptAnalyzer - Validate PowerShell Scripts
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -Repository PSGallery
          Write-Host "Analyzing pre-commit.ps1..."
          $results1 = Invoke-ScriptAnalyzer -Path pre-commit.ps1 -Severity Warning,Error
          Write-Host "Analyzing install.ps1..."
          $results2 = Invoke-ScriptAnalyzer -Path install.ps1 -Severity Warning,Error
          
          $allResults = @($results1) + @($results2)
          
          if ($allResults.Count -gt 0) {
            $allResults | Format-Table -AutoSize
            Write-Error "PSScriptAnalyzer found $($allResults.Count) issue(s)"
            exit 1
          } else {
            Write-Host "✓ No issues found in PowerShell scripts" -ForegroundColor Green
          }

      - name: Install yamllint
        run: |
          sudo apt-get install -y yamllint

      - name: Validate YAML Files
        run: |
          echo "Validating YAML files..."
          find .ai -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "Checking $file..."
            yamllint -d relaxed "$file"
          done
          echo "✓ All YAML files are valid"

      - name: Validate File Structure
        run: |
          echo "Checking required files..."
          
          # Required files
          required_files=(
            ".ai/agents/security/checklist.yaml"
            ".ai/agents/security/prompt.txt"
            ".ai/agents/naming/checklist.yaml"
            ".ai/agents/naming/prompt.txt"
            ".ai/agents/quality/checklist.yaml"
            ".ai/agents/quality/prompt.txt"
            ".ai/agents/summarizer/prompt.txt"
            "pre-commit.sh"
            "pre-commit.ps1"
            "install.sh"
            "install.ps1"
          )
          
          missing=0
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "✗ Missing: $file"
              missing=$((missing + 1))
            else
              echo "✓ Found: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo ""
            echo "Error: $missing required file(s) missing"
            exit 1
          fi
          
          echo ""
          echo "✓ All required files present"

      - name: Summary
        if: success()
        run: |
          echo "=========================================="
          echo "✓ All checks passed!"
          echo "=========================================="
          echo "- Bash scripts validated with ShellCheck"
          echo "- PowerShell scripts validated with PSScriptAnalyzer"
          echo "- YAML files validated with yamllint"
          echo "- File structure verified"
